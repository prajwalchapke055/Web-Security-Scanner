{% extends "layout.html" %}

{% block content %}
<div class="spinner-overlay" id="spinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Scanning...</span>
    </div>
</div>

<div class="card shadow-lg mb-5 border-0 rounded-4"> {# Added shadow-lg, border-0, rounded-4 for modern look #}
    <div class="card-body p-4"> {# Increased padding #}
        <h4 class="card-title mb-3 fw-bold text-primary">Start a New Scan</h4> {# Larger, bolder title #}
        <p class="card-text text-muted">Enter a website URL below to initiate a security scan.</p> {# Added descriptive text #}
        <form method="POST" onsubmit="showSpinner()">
            <div class="input-group input-group-lg"> {# Made input group larger #}
                <input type="url" name="url" class="form-control rounded-start-pill py-3 px-4" placeholder="https://example.com" required> {# Rounded input, more padding #}
                <button class="btn btn-primary rounded-end-pill px-4" type="submit">
                    <i class="bi bi-play-circle-fill me-2"></i> Scan Now {# Added Bootstrap icon #}
                </button>
            </div>
        </form>
    </div>
</div>

{% if stats.total_scans > 0 %}

<div class="row text-center g-4 mb-5"> {# Increased gutter and margin-bottom #}
    <div class="col-md-4">
        <div class="card stat-card h-100 shadow-sm border-0 rounded-4 clickable-card" data-bs-toggle="modal" data-bs-target="#totalScansModal">
            <div class="card-body p-4 d-flex flex-column align-items-center justify-content-center">
                <i class="bi bi-bar-chart-fill icon-lg text-primary mb-3"></i> {# New icon #}
                <h6 class="text-muted text-uppercase mb-2">Total Scans</h6> {# Label uppercase #}
                <h3 class="display-5 fw-bold text-dark">{{ stats.total_scans }}</h3> {# Larger, bolder number #}
                {# Optional: Add a sparkline or trend indicator here #}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card h-100 shadow-sm border-0 rounded-4 clickable-card" data-bs-toggle="modal" data-bs-target="#safeScansModal">
            <div class="card-body p-4 d-flex flex-column align-items-center justify-content-center">
                <i class="bi bi-shield-fill-check icon-lg text-success mb-3"></i> {# New icon, green color #}
                <h6 class="text-muted text-uppercase mb-2">Safe Scans</h6>
                <h3 class="display-5 fw-bold text-success">{{ stats.safe_scans }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card h-100 shadow-sm border-0 rounded-4 clickable-card" data-bs-toggle="modal" data-bs-target="#vulnScansModal">
            <div class="card-body p-4 d-flex flex-column align-items-center justify-content-center">
                <i class="bi bi-exclamation-triangle-fill icon-lg text-danger mb-3"></i> {# New icon, red color #}
                <h6 class="text-muted text-uppercase mb-2">Sites with Issues</h6>
                <h3 class="display-5 fw-bold text-danger">{{ stats.vuln_count }}</h3>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-5">
    <div class="col-lg-7">
        <div class="card shadow-sm mb-4 border-0 rounded-4">
            <div class="card-body p-4 text-center">
                <h5 class="card-title fw-bold mb-3">Overall Security Score</h5> {# Changed to Overall Security Score #}
                <p class="text-muted small mb-4">{{ last_scan_url }}</p>
                <div style="position: relative; height:200px; width: 200px; margin: auto;"> {# Fixed width for gauge #}
                    <canvas id="securityGaugeChart"></canvas>
                    <div id="gaugeText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; font-weight: bold;"></div> {# Dynamic text outside canvas #}
                </div>
                {# Added score interpretation and historical comparison #}
                <div class="mt-4">
                    <p class="mb-1">
                        {% if security_score >= 80 %}
                            <span class="text-success"><i class="bi bi-check-circle-fill"></i> Excellent!</span> Your website security is strong.
                        {% elif security_score >= 50 %}
                            <span class="text-warning"><i class="bi bi-exclamation-circle-fill"></i> Good, but improve.</span> Address medium severity issues.
                        {% else %}
                            <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Critical issues!</span> Immediate action required.
                        {% endif %}
                    </p>
                    {% if previous_security_score is not none %} {# Assuming you pass previous_security_score #}
                        {% if security_score > previous_security_score %}
                            <p class="small text-success mb-0">Score improved by {{ security_score - previous_security_score }} points compared to previous scan.</p>
                        {% elif security_score < previous_security_score %}
                            <p class="small text-danger mb-0">Score decreased by {{ previous_security_score - security_score }} points compared to previous scan.</p>
                        {% else %}
                            <p class="small text-muted mb-0">Score remained consistent with previous scan.</p>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card shadow-sm border-0 rounded-4 h-100">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3">Security Tips & Best Practices</h5>
                <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-lightbulb-fill text-warning fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">Regular Updates</h6>
                        <p class="small text-muted mb-0">Keep all software, libraries, and frameworks up to date to patch known vulnerabilities.</p>
                    </div>
                </div>
                <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-lock-fill text-info fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">Implement Security Headers</h6>
                        <p class="small text-muted mb-0">Use headers like CSP, HSTS, and X-Frame-Options to protect against common attacks.</p>
                    </div>
                </div>
                <div class="d-flex align-items-start">
                    <i class="bi bi-code-slash text-success fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">Secure Coding Practices</h6>
                        <p class="small text-muted mb-0">Always validate and sanitize user inputs to prevent injection attacks (SQLi, XSS, etc.).</p>
                    </div>
                </div>
                <a href="#" class="btn btn-sm btn-outline-primary mt-3">View All Tips <i class="bi bi-arrow-right"></i></a>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-5 border-0 rounded-4">
    <div class="card-body p-4">
        <h5 class="card-title fw-bold mb-3">Scans Over Time</h5>
        <div class="d-flex justify-content-end mb-3">
            <div class="btn-group btn-group-sm" role="group" aria-label="Time Range">
                <button type="button" class="btn btn-outline-secondary active" data-time-range="7">7 Days</button>
                <button type="button" class="btn btn-outline-secondary" data-time-range="30">30 Days</button>
                <button type="button" class="btn btn-outline-secondary" data-time-range="90">90 Days</button>
                {# Add custom range if needed #}
            </div>
        </div>
        <div style="position: relative; height:350px;"> {# Increased height #}
            <canvas id="scansOverTimeChart"></canvas>
        </div>
    </div>
</div>

<div class="card shadow-lg mb-5 border-0 rounded-4"> {# Stronger shadow for this main section #}
    <div class="card-body p-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
            <h5 class="card-title mb-3 mb-md-0 fw-bold">Scan History</h5>
            <div class="d-flex align-items-center">
                <input type="text" id="searchInput" class="form-control me-2 py-2 px-3 rounded-pill" style="max-width: 300px;" placeholder="Search by URL..."> {# Rounded search bar #}
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle rounded-pill" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-funnel-fill me-1"></i> Filter
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="filterDropdown">
                        <li><a class="dropdown-item filter-status" href="#" data-status="all">All Statuses</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="Completed">Completed</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="Pending">Pending</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="Failed">Failed</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item filter-issues" href="#" data-issues="all">All Issues</a></li>
                        <li><a class="dropdown-item filter-issues" href="#" data-issues="with">With Issues</a></li>
                        <li><a class="dropdown-item filter-issues" href="#" data-issues="none">No Issues</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="historyTable">
                <thead class="bg-light"> {# Light background for table header #}
                    <tr>
                        <th class="sortable text-nowrap" data-column="url">URL <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable text-nowrap" data-column="status">Status <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable text-nowrap" data-column="time">Time <i class="bi bi-arrow-down-up"></i></th>
                        <th class="sortable text-nowrap" data-column="issues">Issues Found <i class="bi bi-arrow-down-up"></i></th>
                        <th class="text-nowrap">Actions</th> {# Changed to Actions #}
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    {% for entry in history %}
                        <tr id="scan-row-{{ entry.id }}" class="clickable-row" data-scan-id="{{ entry.id }}" data-href="{{ url_for('report', scan_id=entry.id) if entry.status == 'Completed' else '#' }}"
                            data-status="{{ entry.status }}" data-issues="{{ 'with' if entry.vulns_found > 0 else 'none' }}"> {# Added data attributes for filtering #}
                            <td>
                                <a href="{{ url_for('report', scan_id=entry.id) if entry.status == 'Completed' else '#' }}" class="text-decoration-none text-primary fw-medium">
                                    {{ entry.url }}
                                </a>
                            </td>
                            <td>
                                {% if entry.status == "Completed" %}
                                    <span class="badge bg-success-subtle text-success py-2 px-3 rounded-pill">
                                        <i class="bi bi-check-circle-fill me-1"></i> Completed
                                    </span>
                                {% elif entry.status == "Pending" %}
                                    <span class="badge bg-warning-subtle text-warning py-2 px-3 rounded-pill">
                                        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                        Pending...
                                    </span>
                                {% else %} {# Assuming 'Failed' or other error status #}
                                    <span class="badge bg-danger-subtle text-danger py-2 px-3 rounded-pill">
                                        <i class="bi bi-x-circle-fill me-1"></i> Failed
                                    </span>
                                {% endif %}
                            </td>
                            <td data-timestamp="{{ entry.time }}">{{ entry.time }}</td> {# Original timestamp for date-fns #}
                            <td>
                                {% if entry.vulns_found > 0 %}
                                    <span class="badge bg-danger text-light py-2 px-3 rounded-pill">
                                        <i class="bi bi-bug-fill me-1"></i> {{ entry.vulns_found }} Issues
                                    </span>
                                {% else %}
                                    <span class="badge bg-success-subtle text-success py-2 px-3 rounded-pill">
                                        <i class="bi bi-check-circle-fill me-1"></i> No Issues
                                    </span>
                                {% endif %}
                            </td>
                            <td class="text-nowrap">
                                {% if entry.status == "Completed" %}
                                    <a href="{{ url_for('report', scan_id=entry.id) }}" class="btn btn-sm btn-outline-primary me-2 rounded-pill">
                                        <i class="bi bi-file-earmark-text-fill me-1"></i> View Report
                                    </a>
                                    {# Add a Re-scan button #}
                                    <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="event.stopPropagation(); reScan('{{ entry.url }}');">
                                        <i class="bi bi-arrow-clockwise"></i> Re-scan
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-secondary rounded-pill" disabled>
                                        <i class="bi bi-file-earmark-text me-1"></i> View Report
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {# Placeholder for Pagination #}
        <nav aria-label="Page navigation example" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">Next</a></li>
            </ul>
        </nav>
    </div>
</div>

{% else %}
<div class="alert alert-info text-center p-5 rounded-4 shadow-sm" role="alert"> {# Enhanced styling for empty state #}
    <h3 class="alert-heading text-primary fw-bold mb-3"><i class="bi bi-stars me-2"></i> Welcome to the Web Security Scanner!</h3>
    <p class="lead mb-4">No scans have been performed yet. Use the form above to start your first scan and see your dashboard come to life.</p>
    <button class="btn btn-lg btn-primary rounded-pill px-5 py-3" onclick="document.querySelector('input[name=\'url\']').focus();">
        <i class="bi bi-plus-circle-fill me-2"></i> Start Your First Scan
    </button>
</div>
{% endif %}


<div class="modal fade" id="totalScansModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">All Scanned URLs</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul class="list-group">{% for url in stats.total_scans_list %}<li class="list-group-item">{{ url }}</li>{% endfor %}</ul></div></div></div></div>
<div class="modal fade" id="safeScansModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Safe Scans</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">{% if stats.safe_scans > 0 %}<ul class="list-group">{% for url in stats.safe_scans_list %}<li class="list-group-item">{{ url }}</li>{% endfor %}</ul>{% else %}<p>No scans were found to be completely safe.</p>{% endif %}</div></div></div></div>
<div class="modal fade" id="vulnScansModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Scans with Issues</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">{% if stats.vuln_count > 0 %}<ul class="list-group">{% for url in stats.vulnerable_scans_list %}<li class="list-group-item">{{ url }}</li>{% endfor %}</ul>{% else %}<p>No issues found in any scans.</p>{% endif %}</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script> {# Ensure Chart.js is loaded #}
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/cdn.min.js"></script> {# Ensure date-fns is loaded #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inject Bootstrap Icons if not already present (assuming you'll add it in layout.html)
    // <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    // --- Spinner Logic ---
    window.showSpinner = function() {
        document.getElementById("spinner").style.display = "flex";
    };
    document.querySelector('form[method="POST"]')?.addEventListener('submit', window.showSpinner);

    // --- Chart.js Initializations ---
    const gaugeCtx = document.getElementById('securityGaugeChart')?.getContext('2d');
    const securityScore = {{ security_score or 0 }};
    const gaugeTextElement = document.getElementById('gaugeText');

    if (gaugeCtx && gaugeTextElement) {
        const gaugeColor = securityScore > 80 ? '#28a745' : securityScore > 50 ? '#ffc107' : '#dc3545';
        new Chart(gaugeCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [securityScore, 100 - securityScore],
                    backgroundColor: [gaugeColor, '#e9ecef'],
                    borderWidth: 0,
                    hoverOffset: 0 // Prevents slight movement on hover
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                circumference: 180,
                rotation: 270,
                plugins: {
                    tooltip: {
                        enabled: false // No tooltip for the gauge
                    },
                    legend: {
                        display: false // No legend for the gauge
                    }
                }
            }
        });
        gaugeTextElement.innerHTML = securityScore; // Set score text
        gaugeTextElement.style.color = gaugeColor; // Set score color
    }

    const lineCtx = document.getElementById('scansOverTimeChart')?.getContext('2d');
    let scansOverTimeChart; // Declare chart variable to update it later

    if (lineCtx) {
        const initialLabels = {{ time_series_chart.labels|tojson }};
        const initialCounts = {{ time_series_chart.counts|tojson }};
        const initialVulnCounts = {{ time_series_chart.vuln_counts|tojson if time_series_chart.vuln_counts else '[]' }}; // Assuming you'll pass this from app.py
        
        const chartData = {
            labels: initialLabels,
            datasets: [
                {
                    label: 'Total Scans',
                    data: initialCounts,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.3, // Smoother line
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgb(75, 192, 192)',
                    pointHoverBorderColor: 'rgba(220,220,220,1)',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                },
                {
                    label: 'Scans with Issues', // New dataset for issues
                    data: initialVulnCounts,
                    fill: false,
                    borderColor: 'rgb(255, 99, 132)', // Red for issues
                    tension: 0.3,
                    pointBackgroundColor: 'rgb(255, 99, 132)',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 8,
                    pointHoverBackgroundColor: 'rgb(255, 99, 132)',
                    pointHoverBorderColor: 'rgba(220,220,220,1)',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                }
            ]
        };

        scansOverTimeChart = new Chart(lineCtx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index', // Enable interaction for multiple datasets
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                return context[0].label; // Show date as title
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'bottom' // Place legend at the bottom
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0 // Ensure whole numbers for counts
                        },
                        title: {
                            display: true,
                            text: 'Number of Scans' // Y-axis label
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date' // X-axis label
                        }
                    }
                }
            }
        });
    }

    // --- Time Range Selector for Charts ---
    document.querySelectorAll('.btn-group-sm button[data-time-range]').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.btn-group-sm button[data-time-range]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            const range = this.dataset.timeRange;
            // In a real app, you'd fetch new data based on 'range' via AJAX
            // For now, we'll just demonstrate by re-initializing with placeholder data if needed
            // Example: fetch(`/api/scans-over-time?range=${range}`).then(res => res.json()).then(data => { ... update chart ... });
            // For this example, we'll just log and assume data comes from backend.
            console.log(`Fetching data for ${range} days.`);
            // You would update scansOverTimeChart.data.labels and datasets here and then scansOverTimeChart.update();
        });
    });


    // --- Auto-Update Logic for Pending Scans ---
    const pendingRows = document.querySelectorAll('span.badge.bg-warning-subtle'); // Updated selector
    pendingRows.forEach(badge => {
        const row = badge.closest('tr');
        const scanId = row.dataset.scanId;
        if (scanId) {
            const intervalId = setInterval(() => {
                fetch(`/scan_status/${scanId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'Pending') {
                            clearInterval(intervalId);
                            location.reload(); // Reload the page to show updated status
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching scan status:', error);
                        clearInterval(intervalId); // Stop trying on error
                    });
            }, 5000); // Check every 5 seconds
        }
    });

    // --- Table Interactivity (Live Search, Sorting, Filtering) ---
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('historyTableBody');
    const allRows = tableBody ? Array.from(tableBody.getElementsByTagName('tr')) : []; // Get all rows once

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedStatus = document.querySelector('.filter-status.active')?.dataset.status || 'all';
        const selectedIssues = document.querySelector('.filter-issues.active')?.dataset.issues || 'all';

        allRows.forEach(row => {
            const urlText = row.cells[0].textContent.toLowerCase();
            const status = row.dataset.status;
            const issues = row.dataset.issues;

            const matchesSearch = urlText.includes(searchTerm);
            const matchesStatus = (selectedStatus === 'all' || status === selectedStatus);
            const matchesIssues = (selectedIssues === 'all' || issues === selectedIssues);

            row.style.display = (matchesSearch && matchesStatus && matchesIssues) ? '' : 'none';
        });
    }

    if(searchInput) {
        searchInput.addEventListener('keyup', filterTable);
    }

    document.querySelectorAll('.filter-status').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.filter-status').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            filterTable();
        });
    });

    document.querySelectorAll('.filter-issues').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.filter-issues').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            filterTable();
        });
    });


    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const columnKey = header.dataset.column; // Use a key for sorting
            const isAsc = header.classList.contains('asc');
            
            // Remove sort indicators from all headers
            table.querySelectorAll('th').forEach(th => th.classList.remove('asc', 'desc'));
            // Add current sort indicator
            header.classList.toggle('asc', !isAsc);
            header.classList.toggle('desc', isAsc);

            const dir = isAsc ? -1 : 1; // Determine sort direction

            const sortedRows = Array.from(tbody.querySelectorAll('tr')).sort((a, b) => {
                let valA, valB;

                // Custom sorting logic based on columnKey
                if (columnKey === 'url') {
                    valA = a.cells[0].textContent.toLowerCase();
                    valB = b.cells[0].textContent.toLowerCase();
                    return valA.localeCompare(valB) * dir;
                } else if (columnKey === 'status') {
                    // Custom sort order for status
                    const statusOrder = { 'Pending': 0, 'Failed': 1, 'Completed': 2 };
                    valA = statusOrder[a.dataset.status] !== undefined ? statusOrder[a.dataset.status] : 100;
                    valB = statusOrder[b.dataset.status] !== undefined ? statusOrder[b.dataset.status] : 100;
                    return (valA - valB) * dir;
                } else if (columnKey === 'time') {
                    valA = new Date(a.cells[2].dataset.timestamp).getTime(); // Use original timestamp
                    valB = new Date(b.cells[2].dataset.timestamp).getTime();
                    return (valA - valB) * dir;
                } else if (columnKey === 'issues') {
                    valA = parseInt(a.cells[3].textContent.trim().split(' ')[0]) || 0; // Parse "X Issues" or "No Issues"
                    valB = parseInt(b.cells[3].textContent.trim().split(' ')[0]) || 0;
                    return (valA - valB) * dir;
                }
                return 0; // Should not happen
            });
            sortedRows.forEach(row => tbody.appendChild(row)); // Re-append sorted rows
        });
    });

    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', (e) => {
            // Only navigate if the click is not on a button/link inside the row
            if (!e.target.closest('a') && !e.target.closest('button')) {
                if (row.dataset.href && row.dataset.href !== '#') {
                    window.location.href = row.dataset.href;
                }
            }
        });
    });
    
    // --- "Time Ago" Formatting Logic ---
    try {
        if (typeof dateFns !== 'undefined') {
            document.querySelectorAll('[data-timestamp]').forEach(elem => {
                const timestamp = elem.dataset.timestamp;
                elem.textContent = dateFns.formatDistanceToNow(new Date(timestamp), { addSuffix: true });
            });
        }
    } catch (e) {
        console.error("Could not format dates:", e);
    }

    // Re-scan Function
    window.reScan = function(url) {
        if (confirm(`Are you sure you want to re-scan ${url}?`)) {
            showSpinner();
            fetch('/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            })
            .then(response => response.json()) // Assuming your /scan endpoint returns JSON
            .then(data => {
                if (data.status === 'success') {
                    // Scan started, you might want to redirect or just reload after a delay
                    alert('Re-scan initiated successfully!');
                    location.reload(); 
                } else {
                    alert('Failed to initiate re-scan: ' + (data.message || 'Unknown error'));
                    document.getElementById("spinner").style.display = "none";
                }
            })
            .catch(error => {
                console.error('Error during re-scan:', error);
                alert('An error occurred during re-scan initiation.');
                document.getElementById("spinner").style.display = "none";
            });
        }
    };
});
</script>

{#
<style>

 .sortable { cursor: pointer; user-select: none; } .sortable:hover { background-color: rgba(0,0,0,0.05); } .sortable .bi { margin-left: 5px; color: #aaa; } th.asc .bi, th.desc .bi { color: #000; } body.dark-mode th.asc .bi, body.dark-mode th.desc .bi { color: #fff; }
.clickable-row { cursor: pointer; } .clickable-row:hover { background-color: rgba(0, 0, 0, 0.075); } body.dark-mode .clickable-row:hover { background-color: rgba(255, 255, 255, 0.075); }
.stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; } .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

</style>
#}

{% endblock %}